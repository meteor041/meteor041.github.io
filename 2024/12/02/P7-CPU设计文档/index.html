

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="meteor041">
  <meta name="keywords" content="Computer Organization">
  
    <meta name="description" content="P7-CPU设计文档 流水线架构 123456789101112131415161718192021222324252627- mips.v	- TC0 # 计时器0	- TC1 # 计时器1	- BRIDGE # 系统桥	- CPU.v # 单周期CPU的封装模块        - IF #取指阶段            - pc        - IF_ID #IF与ID之间流水寄存器">
<meta property="og:type" content="article">
<meta property="og:title" content="P7-CPU设计文档">
<meta property="og:url" content="https://meteor041.git.io/2024/12/02/P7-CPU%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/index.html">
<meta property="og:site_name" content="meteor041">
<meta property="og:description" content="P7-CPU设计文档 流水线架构 123456789101112131415161718192021222324252627- mips.v	- TC0 # 计时器0	- TC1 # 计时器1	- BRIDGE # 系统桥	- CPU.v # 单周期CPU的封装模块        - IF #取指阶段            - pc        - IF_ID #IF与ID之间流水寄存器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://meteor041.git.io/2024/12/02/P7-CPU%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/image-20241121014635046.png">
<meta property="og:image" content="https://meteor041.git.io/2024/12/02/P7-CPU%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/image-20241121014944531.png">
<meta property="article:published_time" content="2024-12-02T10:09:52.000Z">
<meta property="article:modified_time" content="2024-12-02T10:10:42.483Z">
<meta property="article:author" content="meteor041">
<meta property="article:tag" content="CO">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://meteor041.git.io/2024/12/02/P7-CPU%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/image-20241121014635046.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>P7-CPU设计文档 - meteor041</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"meteor041.git.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="P7-CPU设计文档"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-02 18:09" pubdate>
          2024年12月2日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          43 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">P7-CPU设计文档</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2024年12月2日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="p7-cpu设计文档">P7-CPU设计文档</h1>
<h2 id="流水线架构">流水线架构</h2>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">-</span> mips.v<br><span class="hljs-bullet">	-</span> TC0 # 计时器0<br><span class="hljs-bullet">	-</span> TC1 # 计时器1<br><span class="hljs-bullet">	-</span> BRIDGE # 系统桥<br><span class="hljs-bullet">	-</span> CPU.v # 单周期CPU的封装模块<br><span class="hljs-bullet">        -</span> IF #取指阶段<br><span class="hljs-bullet">            -</span> pc<br><span class="hljs-bullet">        -</span> IF<span class="hljs-emphasis">_ID #IF与ID之间流水寄存器</span><br><span class="hljs-emphasis">        - ID #译码阶段</span><br><span class="hljs-emphasis">            - ID_</span>CTRL #采用分布式译码<br><span class="hljs-bullet">            -</span> GRF # 寄存器堆<br><span class="hljs-bullet">            -</span> EXT # 立即数扩展<br><span class="hljs-bullet">            -</span> CMP # 比较2个数<br><span class="hljs-bullet">            -</span> NPC # 为B类/J计算下条地址<br><span class="hljs-bullet">        -</span> ID<span class="hljs-emphasis">_EX #ID与EX之间的寄存器</span><br><span class="hljs-emphasis">        - EX  #执行阶段</span><br><span class="hljs-emphasis">            - EX_</span>CTRL #采用分布式译码<br><span class="hljs-bullet">            -</span> ALU # 多功能计算模块<br><span class="hljs-bullet">            -</span> MULT<span class="hljs-emphasis">_DIV # 乘除模块</span><br><span class="hljs-emphasis">        - EX_</span>MEM #EX与MEM之间的寄存器<br><span class="hljs-bullet">        -</span> MEM #存储阶段<br><span class="hljs-bullet">            -</span> MEM<span class="hljs-emphasis">_CTRL #采用分布式译码</span><br><span class="hljs-emphasis">            - MEM_</span>EXT # MEM输出数据扩展位数<br><span class="hljs-bullet">        -</span> MEM<span class="hljs-emphasis">_WB #MEM与WB之间的寄存器</span><br><span class="hljs-emphasis">        - HAZARD_</span>CTRL #冒险控制模块<br><span class="hljs-bullet">        -</span> CP0 #协处理器<br><span class="hljs-code">	</span><br></code></pre></td></tr></table></figure>
<h3 id="if">IF</h3>
<h4 id="顶层">顶层</h4>
<blockquote>
<p>Instruction Fetch阶段,从指令寄存器中读取指令</p>
</blockquote>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td>时钟信号</td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td>重置信号</td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td>中断请求信号</td>
</tr>
<tr>
<td>enablePC</td>
<td>in</td>
<td></td>
<td>使能信号</td>
</tr>
<tr>
<td>NPC</td>
<td>in</td>
<td>[31:0]</td>
<td>PC地址输入</td>
</tr>
<tr>
<td>ID_OP</td>
<td>in</td>
<td>[3:0]</td>
<td>ID区处理指令分支类型</td>
</tr>
<tr>
<td>IF_PC</td>
<td>out</td>
<td>[31:0]</td>
<td>输出PC地址</td>
</tr>
<tr>
<td>IF_BD</td>
<td>out</td>
<td></td>
<td>IF区当前指令是否为延迟槽指令</td>
</tr>
<tr>
<td>IF_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td>IF区异常码</td>
</tr>
</tbody>
</table>
<h4 id="pc部件">PC部件</h4>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td>时钟信号</td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td>重置信号</td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td>中断请求信号</td>
</tr>
<tr>
<td>enable</td>
<td>in</td>
<td></td>
<td>使能信号</td>
</tr>
<tr>
<td>NPC</td>
<td>in</td>
<td>[31:0]</td>
<td>PC地址输入</td>
</tr>
<tr>
<td>PC</td>
<td>out</td>
<td>[31:0]</td>
<td>输出PC地址</td>
</tr>
</tbody>
</table>
<h5 id="pc部件处理逻辑说明">PC部件处理逻辑说明</h5>
<blockquote>
<p>信号优先级:reset &gt; req &gt; enable</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">always</span> @(<span class="hljs-keyword">posedge</span> clk)<span class="hljs-keyword">begin</span><br>      <span class="hljs-keyword">if</span> (reset) <span class="hljs-keyword">begin</span><br>        reg_pc&lt;=<span class="hljs-number">32&#x27;h3000</span>; <span class="hljs-comment">// PC重置</span><br>      <span class="hljs-keyword">end</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req)<span class="hljs-keyword">begin</span><br>        reg_pc &lt;= <span class="hljs-number">32&#x27;h4180</span>; <span class="hljs-comment">// 跳转至32&#x27;H4180,处理异常逻辑代码</span><br>      <span class="hljs-keyword">end</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (enable) <span class="hljs-keyword">begin</span><br>        reg_pc&lt;=NPC;<br>      <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
<h4 id="if区if_bd信号逻辑说明">IF区IF_BD信号逻辑说明</h4>
<blockquote>
<p><code>IF_BD</code>信号用于指定当前IF区指令是否为延迟槽指令;</p>
<p>根据<code>ID_OP</code>信号决定:</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">assign</span> IF_BD = (ID_OP != `ID_NOJUMP) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>
<ul>
<li>若ID区指令为跳转指令(branch, jal, jr, beq, bne, ...),IF_BD置1</li>
<li>反之,IF_BD置0</li>
</ul>
<p>依次经过<code>IF_ID</code>,<code>ID_EX</code>,<code>EX_MEM</code>间流水寄存器,直到<code>PC0</code>,<code>PC0</code>根据该信号决定<code>eret</code>跳转地址(即<code>EPC</code>)</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">EPC &lt;= (BD_in == <span class="hljs-number">1</span>) ? VPC - <span class="hljs-number">32&#x27;D4</span> : VPC;<br></code></pre></td></tr></table></figure>
<ul>
<li>若VPC(受害PC)为延迟槽指令,则EPC设置为该指令的上一条指令地址</li>
<li>若VPC(受害PC)不是延迟槽指令,则EPC设置为该指令地址</li>
</ul>
<p>注:若在4180H处理异常逻辑代码中不修改EPC,直接使用<code>eret</code>指令会导致死循环</p>
</blockquote>
<h3 id="if_id">IF_ID</h3>
<blockquote>
<p>在时钟上升沿将IF_PC,IF_instr的值传递给ID_PC,ID_instr</p>
</blockquote>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td>时钟信号</td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td>重置信号</td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td>中断请求信号</td>
</tr>
<tr>
<td>flush</td>
<td>in</td>
<td></td>
<td>冲洗信号</td>
</tr>
<tr>
<td>enable</td>
<td>in</td>
<td></td>
<td>使能信号</td>
</tr>
<tr>
<td>IF_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>IF传入PC地址</td>
</tr>
<tr>
<td>IF_instr</td>
<td>in</td>
<td>[31:0]</td>
<td>IF传入指令</td>
</tr>
<tr>
<td>IF_ExcCode</td>
<td>in</td>
<td>[4:0]</td>
<td>IF区异常码</td>
</tr>
<tr>
<td>IF_BD</td>
<td>in</td>
<td></td>
<td>IF区延迟槽指令信号</td>
</tr>
<tr>
<td>ID_PC</td>
<td>out</td>
<td>[31:0]</td>
<td>ID接收PC地址</td>
</tr>
<tr>
<td>ID_instr</td>
<td>out</td>
<td>[31:0]</td>
<td>ID接收指令</td>
</tr>
<tr>
<td>ID_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td>ID接收异常码</td>
</tr>
<tr>
<td>ID_BD</td>
<td></td>
<td></td>
<td>ID接收延迟槽指令信号</td>
</tr>
</tbody>
</table>
<blockquote>
<p>优先级:<code>reset &gt; req &gt; enable/flush</code></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">if</span> (reset)<span class="hljs-keyword">begin</span><br> ID_PC &lt;= <span class="hljs-number">32&#x27;h3000</span>;<br> ID_instr &lt;= <span class="hljs-number">32&#x27;h0</span>;<br> ID_ExcCode = <span class="hljs-number">5&#x27;b0</span>;<br> ID_BD = <span class="hljs-number">1&#x27;b0</span>;<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req)<span class="hljs-keyword">begin</span><br> ID_PC &lt;= <span class="hljs-number">32&#x27;h4180</span>; <span class="hljs-comment">// 异常处理程序入口地址</span><br> ID_instr &lt;= <span class="hljs-number">32&#x27;b0</span>; <span class="hljs-comment">// nop</span><br> ID_ExcCode &lt;= <span class="hljs-number">5&#x27;b0</span>;<br> ID_BD &lt;= <span class="hljs-number">1&#x27;b0</span>;<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (enable)<span class="hljs-keyword">begin</span><br> <span class="hljs-keyword">if</span> (flush)<span class="hljs-keyword">begin</span><br>     ID_PC &lt;= <span class="hljs-number">32&#x27;h3000</span>;<br>     ID_instr &lt;= <span class="hljs-number">32&#x27;h0</span>;<br>     ID_ExcCode &lt;= <span class="hljs-number">5&#x27;b0</span>;<br>     ID_BD &lt;= <span class="hljs-number">1&#x27;b0</span>;<br> <span class="hljs-keyword">end</span><br> <span class="hljs-keyword">else</span> <span class="hljs-keyword">begin</span><br>     ID_PC &lt;= IF_PC;<br>     ID_instr &lt;= IF_instr;<br>     ID_ExcCode &lt;= IF_ExcCode;<br>     ID_BD &lt;= IF_BD;<br> <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="id">ID</h3>
<blockquote>
<p>Instruction Decode阶段</p>
</blockquote>
<h4 id="顶层-1">顶层</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>IF/ID输入</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>IF_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>IF区的PC,用于正常的地址+4操作</td>
</tr>
<tr>
<td>ID_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>ID区的PC</td>
</tr>
<tr>
<td>ID_instr</td>
<td>in</td>
<td>[31:0]</td>
<td>ID区的指令</td>
</tr>
<tr>
<td>ID_RD1_forward</td>
<td>in</td>
<td>[31:0]</td>
<td>转发的Data1</td>
</tr>
<tr>
<td>ID_RD2_forward</td>
<td>in</td>
<td>[31:0]</td>
<td>转发的Data2</td>
</tr>
<tr>
<td>ID_ExcCode</td>
<td>in</td>
<td>[4:0]</td>
<td>ID区的异常码</td>
</tr>
<tr>
<td><strong>WB输入</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>WB_WD</td>
<td>in</td>
<td>[31:0]</td>
<td>写入数据,来自于WB阶段</td>
</tr>
<tr>
<td>WB_A3</td>
<td>in</td>
<td>[31:0]</td>
<td>写入寄存器地址,来自于WB阶段</td>
</tr>
<tr>
<td>WB_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>写入数据对应PC地址,传递给<span class="math inline">\(display语句,作为显示,来自于WB阶段 |
|
**ID输出**     |         |        |                                                             |
| ID_RD1         | out     | [31:0] |
ID输出rs寄存器读出值                                        |
| ID_RD2         | out     | [31:0] |
ID输出rt寄存器读出值                                        |
| ID_IMM32       | out     | [31:0] |
ID输出经过位扩展的立即数                                    |
| ID_A3          | out     | [4:0]  |
ID阶段的A3,向后传递用                                       |
| ID_WD          | out     | [31:0] |
ID阶段的写入数据,向后传递                                   |
| NPC            | out     | [31:0] |
ID阶段(内部NPC模块)计算的下一个地址                         |
| ID_A1_USE      | out     | [1:0]  |
ID阶段rs寄存器的\)</span>T_{USE}$</td>
</tr>
<tr>
<td>ID_A2_USE</td>
<td>out</td>
<td>[1:0]</td>
<td>ID阶段rt寄存器的<span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>ID_MD</td>
<td>out</td>
<td></td>
<td>ID区当前是否在处理乘除相关指令</td>
</tr>
<tr>
<td>ID_EX_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td>ID区处理后的异常码</td>
</tr>
<tr>
<td>ID_OP</td>
<td>out</td>
<td></td>
<td>ID区指令的分支类型</td>
</tr>
<tr>
<td>IF_ID_FLUSH</td>
<td>out</td>
<td></td>
<td>对IF_ID间流水寄存器的冲洗信号</td>
</tr>
</tbody>
</table>
<h4 id="ext部件">EXT部件</h4>
<blockquote>
<p>立即数扩展</p>
</blockquote>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>imm16</td>
<td>in</td>
<td>[15:0]</td>
<td>输入的16位立即数</td>
</tr>
<tr>
<td>ExtControl</td>
<td>in</td>
<td></td>
<td>决定零扩展还是符号扩展</td>
</tr>
<tr>
<td>imm32</td>
<td>out</td>
<td>[31:0]</td>
<td>输出的为扩展后的32位立即数</td>
</tr>
</tbody>
</table>
<h4 id="cmp部件">CMP部件</h4>
<blockquote>
<p>判断两个输入(从寄存器取出来的两个值)是否相等,输出zero,用于处理beq信号通路</p>
</blockquote>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>in</td>
<td>[31:0]</td>
<td>输入数据,接收的是转发的Data1(RD1_forward)</td>
</tr>
<tr>
<td>B</td>
<td>in</td>
<td>[31:0]</td>
<td>输入数据,接收的是转发的Data2(RD2_forward)</td>
</tr>
<tr>
<td>CMPControl</td>
<td>in</td>
<td>[3:0]</td>
<td>CMP部件控制信号(选择比较方式)</td>
</tr>
<tr>
<td>zero</td>
<td>out</td>
<td></td>
<td>若相等则输出1,否则输出0</td>
</tr>
</tbody>
</table>
<h4 id="cmpcontrol信号表">CMPControl信号表</h4>
<table>
<thead>
<tr>
<th>指令</th>
<th>CMPControl</th>
</tr>
</thead>
<tbody>
<tr>
<td>cmpBeq</td>
<td>4'b0000</td>
</tr>
<tr>
<td>cmpBgez</td>
<td>4'b0001</td>
</tr>
<tr>
<td>cmpBgtz</td>
<td>4'b0010</td>
</tr>
<tr>
<td>cmpBlez</td>
<td>4'b0011</td>
</tr>
<tr>
<td>cmpBltz</td>
<td>4'b0100</td>
</tr>
<tr>
<td>cmpBne</td>
<td>4'b0101</td>
</tr>
<tr>
<td>bnumeq</td>
<td>4'b1000</td>
</tr>
</tbody>
</table>
<h4 id="npc部件">NPC部件</h4>
<blockquote>
<p>计算下一个PC地址</p>
</blockquote>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>IF_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>IF输出的PC</td>
</tr>
<tr>
<td>ID_PC</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_imm26</td>
<td>in</td>
<td>[25:0]</td>
<td><code>Jal</code>指令中[25:0]位,指定跳转的绝对地址</td>
</tr>
<tr>
<td>imm32</td>
<td>in</td>
<td>[31:0]</td>
<td>经过EXT扩展的立即数</td>
</tr>
<tr>
<td>Jr_Reg_Data</td>
<td>in</td>
<td>[31:0]</td>
<td>Jr指定的寄存器的值</td>
</tr>
<tr>
<td>EPC_out</td>
<td>in</td>
<td>[31:0]</td>
<td>CP0传递的跳转指令</td>
</tr>
<tr>
<td>Branch</td>
<td>in</td>
<td></td>
<td>Branch信号(beq激活)</td>
</tr>
<tr>
<td>Jal</td>
<td>in</td>
<td></td>
<td>Jal信号(jal激活)</td>
</tr>
<tr>
<td>Jr</td>
<td>in</td>
<td></td>
<td>Jr信号(jr激活)</td>
</tr>
<tr>
<td>Eret</td>
<td>in</td>
<td></td>
<td>Eret信号(eret激活)</td>
</tr>
<tr>
<td>NPC</td>
<td>out</td>
<td>[31:0]</td>
<td>下一个PC地址</td>
</tr>
</tbody>
</table>
<h5 id="跳转地址表">跳转地址表</h5>
<table>
<thead>
<tr>
<th>指令</th>
<th>跳转地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>Branch类(beq,bne)</td>
<td><span class="math inline">\(ID\_PC+4+signed(imm32 &lt;&lt;
2)\)</span></td>
</tr>
<tr>
<td>Jal</td>
<td><span class="math inline">\((ID\_PC+4)_{31:28}||ID_imm26||2&#39;b0\)</span></td>
</tr>
<tr>
<td>Jr</td>
<td><span class="math inline">\(Jr\_Reg\_Data\)</span></td>
</tr>
<tr>
<td>Eret</td>
<td><span class="math inline">\(EPC\_out\)</span></td>
</tr>
<tr>
<td>default</td>
<td><span class="math inline">\(IF_PC+4\)</span></td>
</tr>
</tbody>
</table>
<h4 id="control部件共用">Control部件(共用)</h4>
<blockquote>
<p>控制信号生成部件,这里我们采用的是分布式译码,这里展示的共用Control部件在ID阶段被使用的端口</p>
</blockquote>
<table>

<thead>
<tr>
<th style="text-align: left;">端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">instr</td>
<td>in</td>
<td>[31:0]</td>
<td>输入的指令</td>
</tr>
<tr>
<td style="text-align: left;">zero</td>
<td>in</td>
<td></td>
<td>ID_RD1_forward与ID_RD2_forward是否相等</td>
</tr>
<tr>
<td style="text-align: left;">Branch</td>
<td>out</td>
<td></td>
<td>Branch信号(beq激活)</td>
</tr>
<tr>
<td style="text-align: left;">Jal</td>
<td>out</td>
<td></td>
<td>Jal信号(jal激活)</td>
</tr>
<tr>
<td style="text-align: left;">Jr</td>
<td>out</td>
<td></td>
<td>Jr信号(jr激活)</td>
</tr>
<tr>
<td style="text-align: left;">Eret</td>
<td>out</td>
<td></td>
<td>Eret信号(eret激活)</td>
</tr>
<tr>
<td style="text-align: left;">ExtControl</td>
<td>out</td>
<td></td>
<td>控制ext部件的信号</td>
</tr>
<tr>
<td style="text-align: left;">Sel_ID_WD</td>
<td>out</td>
<td></td>
<td>与jal相关,若执行jal指令则为1,该信号为1时将Write
Data(写入寄存器)指定为ID_PC+8</td>
</tr>
<tr>
<td style="text-align: left;">ID_A3</td>
<td>out</td>
<td>[4:0]</td>
<td>解码阶段输出的写入寄存器地址</td>
</tr>
<tr>
<td style="text-align: left;">ID_A1_USE</td>
<td>out</td>
<td>[1:0]</td>
<td>rs的<span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td style="text-align: left;">ID_A2_USE</td>
<td>out</td>
<td>[1:0]</td>
<td>rt的<span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td style="text-align: left;">CMPControl</td>
<td>out</td>
<td>[3:0]</td>
<td>CMP部件控制信号(选择比较方式)</td>
</tr>
<tr>
<td style="text-align: left;">ID_MD</td>
<td>out</td>
<td></td>
<td>ID区当前是否在处理乘除相关指令</td>
</tr>
<tr>
<td style="text-align: left;">ID_OP</td>
<td>out</td>
<td>[3:0]</td>
<td>ID区当前指令分支类型</td>
</tr>
<tr>
<td style="text-align: left;">ri</td>
<td>out</td>
<td></td>
<td>未知指令异常信号</td>
</tr>
<tr>
<td style="text-align: left;">SYSCALL</td>
<td>out</td>
<td></td>
<td>系统调用指令信号</td>
</tr>
</tbody>
</table>
<h4 id="id控制信号表">ID控制信号表</h4>
<table>
<thead>
<tr>
<th>指令/信号</th>
<th>ExtControl</th>
<th>ID_A3</th>
</tr>
</thead>
<tbody>
<tr>
<td>ori</td>
<td>1(立即数零扩展)</td>
<td>rt</td>
</tr>
<tr>
<td>add</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>sub</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>lw</td>
<td>0(立即数符号扩展)</td>
<td>rt</td>
</tr>
<tr>
<td>sw</td>
<td>0(立即数符号扩展)</td>
<td>$0</td>
</tr>
<tr>
<td>beq</td>
<td>0(立即数符号扩展)</td>
<td>$0</td>
</tr>
<tr>
<td>lui</td>
<td>0(立即数符号扩展)(其实随意)</td>
<td>rt</td>
</tr>
<tr>
<td>jal</td>
<td>\</td>
<td>$31</td>
</tr>
<tr>
<td>jr</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>swc</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>bonall</td>
<td>0(立即数符号扩展)</td>
<td>31</td>
</tr>
<tr>
<td>lh</td>
<td>0</td>
<td>rt</td>
</tr>
<tr>
<td>sh</td>
<td>0</td>
<td>\</td>
</tr>
<tr>
<td>lb</td>
<td>0</td>
<td>rt</td>
</tr>
<tr>
<td>sb</td>
<td>0</td>
<td>\</td>
</tr>
<tr>
<td>and</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>or</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>slt</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>sltu</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>addi</td>
<td>0</td>
<td>rt</td>
</tr>
<tr>
<td>andi</td>
<td>0</td>
<td>rt</td>
</tr>
<tr>
<td>mult</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>multu</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>div</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>divu</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>mflo</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>mfhi</td>
<td>\</td>
<td>rd</td>
</tr>
<tr>
<td>mtlo</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>mthi</td>
<td>\</td>
<td>$0</td>
</tr>
<tr>
<td>mfc0</td>
<td>\</td>
<td>rt</td>
</tr>
</tbody>
</table>
<p>其余信号:</p>
<ul>
<li><p><span class="math inline">\(beq/bne\rightarrow
Branch\)</span></p></li>
<li><p><span class="math inline">\(jal\rightarrow
Sel\_ID\_WD\)</span></p></li>
<li><p><span class="math inline">\(jal\rightarrow Jal\)</span></p></li>
<li><p><span class="math inline">\(jr\rightarrow Jr\)</span></p></li>
<li><p><span class="math inline">\(eret\rightarrow
Eret\)</span></p></li>
<li><p><span class="math inline">\(mult/multu/div/divu/mfhi/mflo/mthi/mtlo(8)\rightarrow
ID\_MD\)</span></p></li>
<li><p><span class="math inline">\(branch/jal/jr\rightarrow
ID\_OP=JUMP,else\rightarrow NOJUMP\)</span></p></li>
<li><p><span class="math inline">\(syscall\rightarrow
SYSCALL\)</span></p></li>
</ul>
<h4 id="t_use表"><span class="math inline">\(T_{USE}\)</span>表</h4>
<table>
<thead>
<tr>
<th></th>
<th>ID_A1_USE</th>
<th>ID_A2_USE</th>
</tr>
</thead>
<tbody>
<tr>
<td>cal_r</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>cal_i</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>load</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>store</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>cal_md</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>load_md</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>store_md</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>branch</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>cal_jal</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>cal_jr</td>
<td>0</td>
<td>3</td>
</tr>
<tr>
<td><strong>P7新增指令(未分类)</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td>eret</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>mfc0</td>
<td>3</td>
<td>3</td>
</tr>
<tr>
<td>mtc0</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>syscall</td>
<td>3</td>
<td>3</td>
</tr>
</tbody>
</table>
<h4 id="grf部件">GRF部件</h4>
<blockquote>
<p>32个32bit寄存器组成的寄存器堆</p>
</blockquote>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>A1</td>
<td>in</td>
<td>[4:0]</td>
<td>A1读出寄存器地址</td>
</tr>
<tr>
<td>A2</td>
<td>in</td>
<td>[4:0]</td>
<td>A2读出寄存器地址</td>
</tr>
<tr>
<td>A3</td>
<td>in</td>
<td>[4:0]</td>
<td>A3写入寄存器地址</td>
</tr>
<tr>
<td>WD</td>
<td>in</td>
<td>[31:0]</td>
<td>写入数据</td>
</tr>
<tr>
<td>PC</td>
<td>in</td>
<td>[31:0]</td>
<td>当前PC($display用)</td>
</tr>
<tr>
<td>RD1</td>
<td>out</td>
<td>[31:0]</td>
<td>A1寄存器读出值</td>
</tr>
<tr>
<td>RD2</td>
<td>out</td>
<td>[31:0]</td>
<td>A2寄存器读出值</td>
</tr>
</tbody>
</table>
<h3 id="id_ex">ID_EX</h3>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>enable</td>
<td>in</td>
<td></td>
<td>使能信号</td>
</tr>
<tr>
<td>flush</td>
<td>in</td>
<td></td>
<td>冲洗信号,和reset作用相同</td>
</tr>
<tr>
<td>ID_PC</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_instr</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_RD1</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_RD2</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_imm32</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_A3</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>ID_WD</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_BD</td>
<td>in</td>
<td></td>
<td>ID区branch delay信号</td>
</tr>
<tr>
<td>ID_EX_ExcCode</td>
<td>in</td>
<td>[4:0]</td>
<td>ID区异常码</td>
</tr>
<tr>
<td>EX_PC</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_instr</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_RD1</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_RD2</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_imm32</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_A3</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>EX_WD</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_BD</td>
<td>out</td>
<td></td>
<td>EX区接收branch delay信号</td>
</tr>
<tr>
<td>EX_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td>EX区接收异常码</td>
</tr>
</tbody>
</table>
<h3 id="ex">EX</h3>
<h4 id="顶层-2">顶层</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>EX_instr</td>
<td>in</td>
<td>[31:0]</td>
<td>EX阶段的指令</td>
</tr>
<tr>
<td>EX_imm32</td>
<td>in</td>
<td>[31:0]</td>
<td>32位扩展的立即数</td>
</tr>
<tr>
<td>EX_WD</td>
<td>in</td>
<td>[31:0]</td>
<td>EX阶段接收的写入寄存器堆的数据</td>
</tr>
<tr>
<td>EX_RD1_forward</td>
<td>in</td>
<td>[31:0]</td>
<td>接收hazard ctrl部件向EX阶段传递的转发数据寄存器A1值</td>
</tr>
<tr>
<td>EX_RD2_forward</td>
<td>in</td>
<td>[31:0]</td>
<td>接收hazard ctrl部件向EX阶段传递的转发数据寄存器A2值</td>
</tr>
<tr>
<td>EX_ExcCode</td>
<td>in</td>
<td>[4:0]</td>
<td>EX接收区异常码</td>
</tr>
<tr>
<td>EX_MEM_RES</td>
<td>out</td>
<td>[31:0]</td>
<td>传递ALU计算结果</td>
</tr>
<tr>
<td>EX_MEM_WD</td>
<td>out</td>
<td>[31:0]</td>
<td>传递给EX_MEM流水寄存器的Write Data</td>
</tr>
<tr>
<td>EX_MEM_RD2</td>
<td>out</td>
<td>[31:0]</td>
<td>传递给EX_MEM流水寄存器的Read Data2</td>
</tr>
<tr>
<td>EX_NEW</td>
<td>out</td>
<td>[1:0]</td>
<td>EX阶段的<span class="math inline">\(T_{NEW}\)</span></td>
</tr>
<tr>
<td>MULT_DIV_BUSY</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MULT_DIV_START</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>EX_MEM_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="mult_div部件">MULT_DIV部件</h4>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td>时钟信号</td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td>重制信号</td>
</tr>
<tr>
<td>A</td>
<td>in</td>
<td>[31:0]</td>
<td>计算数A</td>
</tr>
<tr>
<td>B</td>
<td>in</td>
<td>[31:0]</td>
<td>计算数B</td>
</tr>
<tr>
<td>start</td>
<td>in</td>
<td></td>
<td>有效一个时钟周期,启动信号</td>
</tr>
<tr>
<td>MULT_DIV_OP</td>
<td>in</td>
<td>[2:0]</td>
<td>乘除模块计算方式</td>
</tr>
<tr>
<td>MFHI</td>
<td>in</td>
<td></td>
<td>mfhi信号</td>
</tr>
<tr>
<td>MFLO</td>
<td>in</td>
<td></td>
<td>mflo信号</td>
</tr>
<tr>
<td>busy</td>
<td>out</td>
<td></td>
<td>输出延迟信号</td>
</tr>
<tr>
<td>HI</td>
<td>out</td>
<td>[31:0]</td>
<td>$hi值</td>
</tr>
<tr>
<td>LO</td>
<td>out</td>
<td>[31:0]</td>
<td>$lo值</td>
</tr>
</tbody>
</table>
<h4 id="乘除槽相关信号表">乘除槽相关信号表</h4>
<table>

<thead>
<tr>
<th>指令/信号</th>
<th>MULT_DIV_OP</th>
<th>MULT_DIV_START</th>
</tr>
</thead>
<tbody>
<tr>
<td>mult</td>
<td><code>mult       | 1              | | multu     |</code>multu</td>
<td>1</td>
</tr>
<tr>
<td>div</td>
<td><code>div        | 1              | | divu      |</code>divu</td>
<td>1</td>
</tr>
</tbody>
</table>
<h4 id="alu部件">ALU部件</h4>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>SrcA</td>
<td>in</td>
<td>[31:0]</td>
<td>操作数A</td>
</tr>
<tr>
<td>SrcB</td>
<td>in</td>
<td>[31:0]</td>
<td>操作数B</td>
</tr>
<tr>
<td>ALUOp</td>
<td>in</td>
<td>[3:0]</td>
<td>计算方式</td>
</tr>
<tr>
<td>ALURes</td>
<td>out</td>
<td>[31:0]</td>
<td>ALU计算结果</td>
</tr>
<tr>
<td>overflow</td>
<td>out</td>
<td></td>
<td>是否溢出</td>
</tr>
</tbody>
</table>
<h4 id="control部件共用-1">Control部件(<em>共用</em>)</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>instr</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ALUOp</td>
<td>out</td>
<td>[3:0]</td>
<td>选择ALU操作方式</td>
</tr>
<tr>
<td><del>ALU_A_Sel</del></td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ALU_B_Sel</td>
<td>out</td>
<td></td>
<td>选择32位立即数或者寄存器rt的值</td>
</tr>
<tr>
<td>WD_Sel</td>
<td>out</td>
<td></td>
<td>选择Write Data来源(1:ID阶段的PC+8,0:ALURes)</td>
</tr>
<tr>
<td>EX_NEW</td>
<td>out</td>
<td></td>
<td>当前EX阶段<span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>MULT_DIV_OP</td>
<td>out</td>
<td></td>
<td>乘除模块计算方式</td>
</tr>
<tr>
<td>MULT_DIV _START</td>
<td>out</td>
<td></td>
<td>乘除模块开始信号</td>
</tr>
<tr>
<td>MTHI</td>
<td>out</td>
<td></td>
<td>mthi信号,下同理</td>
</tr>
<tr>
<td>MTLO</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MFHI</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MFLO</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MTC0</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>LOAD</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>STORE</td>
<td>out</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="ex控制信号表">EX控制信号表</h4>
<table>

<thead>
<tr>
<th>指令/信号</th>
<th>ALUOp</th>
<th>ALU_B_Sel</th>
<th>WD_Sel</th>
</tr>
</thead>
<tbody>
<tr>
<td>ori</td>
<td><code>aluOr   | 1(选择立即数)   | 0(Write Data选择aluRes)   | | add       |</code>aluAdd</td>
<td>0(选择rt寄存器)</td>
<td>0</td>
</tr>
<tr>
<td>sub</td>
<td><code>aluSub  | 0(选择rt寄存器) | 0                         | | beq       | \        | \               | \                         | | lw        |</code>aluAdd</td>
<td>1(选择立即数)</td>
<td>0</td>
</tr>
<tr>
<td>sw</td>
<td><code>aluAdd  | 1(选择立即数)   | 0                         | | lh        |</code>aluAdd</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>sh</td>
<td><code>aluAdd  | 1               | 0                         | | lb        |</code>aluAdd</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>sb</td>
<td><code>aluAdd  | 1               | 0                         | | lui       |</code>aluLui</td>
<td>1(选择立即数)</td>
<td>0</td>
</tr>
<tr>
<td>jal</td>
<td>\</td>
<td>\</td>
<td>1(Write Data选择ID传递值)</td>
</tr>
<tr>
<td>jr</td>
<td>\</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>and</td>
<td><code>aluAnd  | 0(选择rt寄存器) | 0                         | | or        |</code>aluOr</td>
<td>0(选择rt寄存器)</td>
<td>0</td>
</tr>
<tr>
<td>slt</td>
<td><code>aluSlt  | 0               | 0                         | | sltu      |</code>aluSltu</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>addi</td>
<td><code>aluAdd  | 1               | 0                         | | andi      |</code>aluAnd</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>mult</td>
<td>\</td>
<td>\</td>
<td>0</td>
</tr>
<tr>
<td>mflo</td>
<td>\</td>
<td>\</td>
<td>\</td>
</tr>
<tr>
<td>mfhi</td>
<td>\</td>
<td>\</td>
<td>\</td>
</tr>
</tbody>
</table>
<h4 id="ext_new表">EX<span class="math inline">\(T_{NEW}\)</span>表</h4>
<table>
<thead>
<tr>
<th></th>
<th>EX_NEW</th>
</tr>
</thead>
<tbody>
<tr>
<td>cal_r</td>
<td>1</td>
</tr>
<tr>
<td>cal_i</td>
<td>1</td>
</tr>
<tr>
<td>load</td>
<td>2</td>
</tr>
<tr>
<td>store</td>
<td>0</td>
</tr>
<tr>
<td>cal_md</td>
<td>0</td>
</tr>
<tr>
<td>load_md</td>
<td>1</td>
</tr>
<tr>
<td>store_md</td>
<td>0</td>
</tr>
<tr>
<td>cal_jal</td>
<td>0</td>
</tr>
<tr>
<td>cal_jr</td>
<td>0</td>
</tr>
<tr>
<td>branch</td>
<td>0</td>
</tr>
<tr>
<td><strong>P7新增指令(未分类)</strong></td>
<td></td>
</tr>
<tr>
<td>mfc0</td>
<td>2</td>
</tr>
<tr>
<td>mtc0</td>
<td>0</td>
</tr>
<tr>
<td>eret</td>
<td>0</td>
</tr>
<tr>
<td>syscall</td>
<td>0</td>
</tr>
</tbody>
</table>
<h3 id="ex_mem">EX_MEM</h3>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>flush</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>EX_PC</td>
<td>in</td>
<td>[31:0]</td>
<td>EX阶段PC地址</td>
</tr>
<tr>
<td>EX_instr</td>
<td>in</td>
<td>[31:0]</td>
<td>EX阶段指令</td>
</tr>
<tr>
<td>EX_A3</td>
<td>out</td>
<td>[4:0]</td>
<td>EX阶段传递的A3</td>
</tr>
<tr>
<td>EX_WD</td>
<td>out</td>
<td>[31:0]</td>
<td>EX阶段Write Data</td>
</tr>
<tr>
<td>EX_RES</td>
<td>out</td>
<td>[31:0]</td>
<td>EX阶段ALURes</td>
</tr>
<tr>
<td>EX_RD2</td>
<td>out</td>
<td>[31:0]</td>
<td>EX阶段Read Data2</td>
</tr>
<tr>
<td>EX_BD</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_PC</td>
<td>out</td>
<td>[31:0]</td>
<td>MEM阶段PC地址</td>
</tr>
<tr>
<td>MEM_instr</td>
<td>out</td>
<td>[31:0]</td>
<td>MEM阶段指令</td>
</tr>
<tr>
<td>MEM_A3</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_WD</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_RES</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_RD2</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_BD</td>
<td>out</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="mem">MEM</h3>
<h4 id="顶层-3">顶层</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_PC</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_instr</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_WD</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_RES</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_RD2_forward</td>
<td>in</td>
<td>[31:0]</td>
<td>WB转发的Read Data2</td>
</tr>
<tr>
<td>MEM_A3</td>
<td>in</td>
<td>[4:0]</td>
<td>MEM传递的A3寄存器地址</td>
</tr>
<tr>
<td>RD</td>
<td>in</td>
<td>[31:0]</td>
<td>从Memory中读出的数据</td>
</tr>
<tr>
<td>MEM_ExcCode</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>CP0_out</td>
<td>in</td>
<td>[31:0]</td>
<td>CP0读出数据</td>
</tr>
<tr>
<td>MEM_WB_A3</td>
<td>out</td>
<td>[4:0]</td>
<td>MEM区传递接收写入数据的A3寄存器,传递至WB区</td>
</tr>
<tr>
<td>MEM_WB_WD</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_A2_NEW</td>
<td>out</td>
<td>[1:0]</td>
<td>MEM<span class="math inline">\(T_{NEW}\)</span></td>
</tr>
<tr>
<td>MEM_BYTE_EN</td>
<td>out</td>
<td>[3:0]</td>
<td>写入MEM数据的按字节使能信号</td>
</tr>
<tr>
<td>MEM_WRITE_DATA</td>
<td>out</td>
<td>[31:0]</td>
<td>写入MEM,按字节重新排序的数据</td>
</tr>
<tr>
<td>MEM_DATA_ADDR</td>
<td>out</td>
<td>[31:0]</td>
<td>写入或读出的Memory地址</td>
</tr>
<tr>
<td>MEM_INST_ADDR</td>
<td>out</td>
<td>[31:0]</td>
<td>当load/store指令对应的PC地址</td>
</tr>
<tr>
<td>MEM_WB_ExcCode</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>CP0_enable</td>
<td>out</td>
<td></td>
<td>CP0写入数据信号</td>
</tr>
<tr>
<td>mfc0_rd</td>
<td>out</td>
<td>[4:0]</td>
<td>mfc0/mtc0指定的寄存器rd</td>
</tr>
<tr>
<td>EXL_clr</td>
<td>out</td>
<td></td>
<td>EXL清空信号,由eret指令发出</td>
</tr>
</tbody>
</table>
<h4 id="memcontrol部件共用">MEMControl部件(共用)</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>instr</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_WE</td>
<td>out</td>
<td></td>
<td>选择是否写入Memory</td>
</tr>
<tr>
<td>MEM_Sel</td>
<td>out</td>
<td></td>
<td>选择是否将Memory读出值向后传递(1:yes)</td>
</tr>
<tr>
<td>MEM_A2_NEW</td>
<td>out</td>
<td></td>
<td>MEM区<span class="math inline">\(T_{NEW}\)</span></td>
</tr>
<tr>
<td>MEM_PART</td>
<td>out</td>
<td>[1:0]</td>
<td>选择存入/读取Word,Half或者Byte</td>
</tr>
<tr>
<td>MEM_EXT_Control</td>
<td>out</td>
<td>[2:0]</td>
<td>MEM_EXT部件控制信号</td>
</tr>
<tr>
<td>CP0_Sel</td>
<td>out</td>
<td></td>
<td>读出数据来源选择CP0(由mfc0发出)</td>
</tr>
<tr>
<td>mfc0_rd</td>
<td>out</td>
<td>[4:0]</td>
<td>mfc0/mtc0指定,输出指令对应的rd</td>
</tr>
<tr>
<td>EXL_clr</td>
<td>out</td>
<td></td>
<td>EXL清空信号,由eret指令发出</td>
</tr>
</tbody>
</table>
<h4 id="mem信号及t_new表">MEM信号及<span class="math inline">\(T_{NEW}\)</span>表</h4>
<table>

<thead>
<tr>
<th>指令/信号</th>
<th>MEM_WE</th>
<th>MEM_Sel</th>
<th>MEM_A2_NEW</th>
<th>MEM_PART</th>
<th>MEM_EXT_Control</th>
</tr>
</thead>
<tbody>
<tr>
<td>sw</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td><code>memWord</code></td>
<td>3'bz</td>
</tr>
<tr>
<td>sh</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td><code>memHalf</code></td>
<td>3'bz</td>
</tr>
<tr>
<td>sb</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td><code>memByte</code></td>
<td>3'bz</td>
</tr>
<tr>
<td>lw</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td><code>memWord |</code>nonExt</td>
<td></td>
</tr>
<tr>
<td>lh</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td><code>memHalf |</code>signedHalfExt</td>
<td></td>
</tr>
<tr>
<td>lb</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td><code>memByte |</code>signedByteExt</td>
<td></td>
</tr>
<tr>
<td>else</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td><code>none</code></td>
<td>3'bz</td>
</tr>
</tbody>
</table>
<h3 id="mem_wb">MEM_WB</h3>
<table>
<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>req</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_PC</td>
<td>in</td>
<td>[31;0]</td>
<td></td>
</tr>
<tr>
<td>MEM_instr</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_A3</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_WD</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>WB_PC</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>WB_instr</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>WB_A3</td>
<td>out</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>WB_WD</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="hazard_ctrl">HAZARD_CTRL</h3>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>ID阶段</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ID_A1</td>
<td>in</td>
<td>[4:0]</td>
<td>ID阶段正在使用的A1寄存器</td>
</tr>
<tr>
<td>ID_A2</td>
<td>in</td>
<td>[4:0]</td>
<td>ID阶段正在使用的A2寄存器</td>
</tr>
<tr>
<td>ID_RD1</td>
<td>in</td>
<td>[31:0]</td>
<td>ID阶段寄存器堆读出的A1对应值</td>
</tr>
<tr>
<td>ID_RD2</td>
<td>in</td>
<td>[31:0]</td>
<td>ID阶段寄存器堆读出的A2对应值</td>
</tr>
<tr>
<td>ID_A1_USE</td>
<td>in</td>
<td>[1:0]</td>
<td><span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>ID_A2_USE</td>
<td>in</td>
<td>[1:0]</td>
<td><span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>ID_MD</td>
<td>in</td>
<td></td>
<td>ID区处理指令是否与乘除相关</td>
</tr>
<tr>
<td><strong>EX阶段</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EX_A1</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>EX_A2</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>EX_RD1</td>
<td>in</td>
<td>[31:0]</td>
<td>IE阶段A2对应值,由ID区的转发值得来</td>
</tr>
<tr>
<td>EX_RD2</td>
<td>in</td>
<td>[31:0]</td>
<td>IE阶段A2对应值,由ID区的转发值得来</td>
</tr>
<tr>
<td>EX_A1_USE</td>
<td>in</td>
<td>[1:0]</td>
<td><span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>EX_A2_USE</td>
<td>in</td>
<td>[1:0]</td>
<td><span class="math inline">\(T_{USE}\)</span></td>
</tr>
<tr>
<td>EX_A3</td>
<td>in</td>
<td>[4:0]</td>
<td>EX传递的A3寄存器(rd)</td>
</tr>
<tr>
<td>EX_WD</td>
<td>in</td>
<td>[31:0]</td>
<td>EX传递的Write Data</td>
</tr>
<tr>
<td>MULT_DIV_BUSY</td>
<td>in</td>
<td></td>
<td>乘除模块忙碌信号</td>
</tr>
<tr>
<td>MULT_DIV_START</td>
<td>in</td>
<td></td>
<td>乘除模块开始信号</td>
</tr>
<tr>
<td><strong>MEM阶段</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEM_A2</td>
<td>in</td>
<td>[4:0]</td>
<td>MEM正在使用的A2</td>
</tr>
<tr>
<td>MEM_RD2</td>
<td>in</td>
<td>[31:0]</td>
<td>MEM的Read Data2,由EX传递而来</td>
</tr>
<tr>
<td>MEM_A2_NEW</td>
<td>in</td>
<td>[1:0]</td>
<td>MEM的<span class="math inline">\(T_{NEW}\)</span></td>
</tr>
<tr>
<td>MEM_A3</td>
<td>in</td>
<td>[4:0]</td>
<td>MEM传递A3</td>
</tr>
<tr>
<td>MEM_WD</td>
<td>in</td>
<td>[31:0]</td>
<td>MEM传递的Write Data</td>
</tr>
<tr>
<td><strong>WB</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>WB_A3</td>
<td>in</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>WB_WD</td>
<td>in</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>转发FORWARD</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ID_RD1_forward</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ID_RD2_forward</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_RD1_forward</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>EX_RD2_forward</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>MEM_RD2_forward</td>
<td>out</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>暂停信号STALL</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Enable_PC</td>
<td>out</td>
<td></td>
<td>PC使能信号</td>
</tr>
<tr>
<td>Enable_IF_ID</td>
<td>out</td>
<td></td>
<td>IF_ID流水寄存器使能信号</td>
</tr>
<tr>
<td>Enable_ID_EX</td>
<td>out</td>
<td></td>
<td>ID_EX流水寄存器使能信号</td>
</tr>
<tr>
<td>Flush_ID_EX</td>
<td>out</td>
<td></td>
<td>ID_EX流水寄存器刷新信号</td>
</tr>
<tr>
<td>Flush_EX_MEM</td>
<td>out</td>
<td></td>
<td>EX_MEM流水寄存器刷新信号</td>
</tr>
</tbody>
</table>
<h3 id="cpu">CPU</h3>
<h4 id="端口">端口</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>in</td>
<td></td>
<td>时钟信号</td>
</tr>
<tr>
<td>reset</td>
<td>in</td>
<td></td>
<td>同步复位信号</td>
</tr>
<tr>
<td>HW_Int</td>
<td>in</td>
<td>[5:0]</td>
<td>用于传递来自计时器和外部的中断信号</td>
</tr>
<tr>
<td><strong>F区</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>i_inst_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>需要进行取指操作的流水级 PC（一般为 F 级)</td>
</tr>
<tr>
<td>i_inst_rdata</td>
<td>in</td>
<td>[31:0]</td>
<td>i_inst_addr 对应的 32 位指令</td>
</tr>
<tr>
<td><strong>BRIDGE</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>m_data_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>BRIDGE待写入地址</td>
</tr>
<tr>
<td>m_data_rdata</td>
<td>in</td>
<td>[31:0]</td>
<td>CPU_addr 对应的 32 位数据</td>
</tr>
<tr>
<td>m_data_wdata</td>
<td>out</td>
<td>[31:0]</td>
<td>BRIDGE待写入数据</td>
</tr>
<tr>
<td>m_data_byteen</td>
<td>out</td>
<td>[3:0]</td>
<td>BRIDGE字节使能信号</td>
</tr>
<tr>
<td><strong>MEM区</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>m_inst_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>M 级 PC</td>
</tr>
<tr>
<td><strong>WB区</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>w_grf_we</td>
<td>out</td>
<td></td>
<td>GRF 写使能信号</td>
</tr>
<tr>
<td>w_grf_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>GRF 中待写入寄存器编号</td>
</tr>
<tr>
<td>w_grf_wdata</td>
<td>out</td>
<td>[31:0]</td>
<td>GRF 中待写入数据</td>
</tr>
<tr>
<td>w_inst_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>W 级 PC</td>
</tr>
<tr>
<td>macroscopic_pc</td>
<td>out</td>
<td>[31:0]</td>
<td>宏观PC</td>
</tr>
</tbody>
</table>
<h3 id="bridge">BRIDGE</h3>
<h4 id="端口-1">端口</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>In/Out?</th>
<th>位宽</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CPU内部传出数据</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PR_addr</td>
<td>in</td>
<td>[31:0]</td>
<td>寄存器内部EX_MEM流水寄存器输出的store地址</td>
</tr>
<tr>
<td>PR_WD</td>
<td>in</td>
<td>[31:0]</td>
<td>寄存器内部EX_MEM流水寄存器输出的store数据</td>
</tr>
<tr>
<td>PR_byteen</td>
<td>in</td>
<td>[31:0]</td>
<td>寄存器字节使能信号</td>
</tr>
<tr>
<td><strong>根据DEV_addr<br>从各部件获取数据</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>DEV_addr</td>
<td>out</td>
<td>[31:0]</td>
<td>将PR_addr[X:2]直接输出即可,X由N个设备中地址空间需求最大者决定</td>
</tr>
<tr>
<td>DM_RD</td>
<td>in</td>
<td>[31:0]</td>
<td>MEM区DM的读出数据</td>
</tr>
<tr>
<td>TC0_RD</td>
<td>in</td>
<td>[31:0]</td>
<td>计数器0的读出数据</td>
</tr>
<tr>
<td>TC1_RD</td>
<td>in</td>
<td>[31:0]</td>
<td>计数器1的读出数据</td>
</tr>
<tr>
<td><strong>对DEV_addr写入<br>(字节)数据使能信号</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>DM_byteen</td>
<td>out</td>
<td>[3:0]</td>
<td>字节使能信号</td>
</tr>
<tr>
<td>TC0_enable</td>
<td>out</td>
<td></td>
<td>TC0写入使能信号</td>
</tr>
<tr>
<td>TC1_enable</td>
<td>out</td>
<td></td>
<td>TC1写入使能信号</td>
</tr>
<tr>
<td>INT_byteen</td>
<td>out</td>
<td>[31:0]</td>
<td>中断发生器字节使能信号</td>
</tr>
<tr>
<td><strong>load相关,将写入<br>寄存器的值传回CPU</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PR_RD</td>
<td>out</td>
<td>[31:0]</td>
<td>输出到WB阶段,写入GRF的数据</td>
</tr>
</tbody>
</table>
<h4 id="地址图">地址图</h4>
<table>

<thead>
<tr>
<th>条目</th>
<th>地址或地址范围</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据存储器</td>
<td>0x0000_0000∼0x0000_2FFF</td>
<td></td>
</tr>
<tr>
<td>指令存储器</td>
<td>0x0000_3000∼0x0000_6FFF</td>
<td></td>
</tr>
<tr>
<td>PC 初始值</td>
<td>0x0000_30000x0000_3000</td>
<td></td>
</tr>
<tr>
<td>异常处理程序入口地址</td>
<td>0x0000_41800x0000_4180</td>
<td></td>
</tr>
<tr>
<td>计时器 0 寄存器地址</td>
<td>0x0000_7F00∼0x0000_7F0B</td>
<td>计时器 0 的 3 个寄存器</td>
</tr>
<tr>
<td>计时器 1 寄存器地址</td>
<td>0x0000_7F10∼0x0000_7F1B</td>
<td>计时器 1 的 3 个寄存器</td>
</tr>
<tr>
<td>中断发生器响应地址</td>
<td>0x0000_7F20∼0x0000_7F23</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="地址匹配方式">地址匹配方式</h4>
<ul>
<li>设备基地址:分为<strong>高位</strong>和<strong>低位</strong>
<ul>
<li>基地址低位:位数由设备占用空间大小决定,也就是偏移地址的位数</li>
<li>基地址高位:<code>Bridge</code>用于译码选择设备</li>
</ul></li>
</ul>
<h3 id="cp0">CP0</h3>
<h4 id="寄存器">寄存器</h4>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>编号</th>
<th>功能</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>SR</td>
<td>12</td>
<td>配置异常的功能。</td>
<td></td>
</tr>
<tr>
<td>Cause</td>
<td>13</td>
<td>记录异常发生的原因和情况。</td>
<td></td>
</tr>
<tr>
<td>EPC</td>
<td>14</td>
<td>记录异常处理结束后需要返回的 PC。</td>
<td></td>
</tr>
</tbody>
</table>
<table>

<thead>
<tr>
<th>寄存器</th>
<th>功能域</th>
<th>位域</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>SR（State Register）</td>
<td>IM（Interrupt Mask）</td>
<td>15:10</td>
<td>分别对应六个外部中断，相应位置 1 表示允许中断，置 0
表示禁止中断。这是一个被动的功能，只能通过 <code>mtc0</code>
这个指令修改，通过修改这个功能域，我们可以屏蔽一些中断。</td>
</tr>
<tr>
<td>SR（State Register）</td>
<td>EXL（Exception Level）</td>
<td>1</td>
<td>任何异常发生时置位，这会强制进入核心态（也就是进入异常处理程序）并禁止中断。</td>
</tr>
<tr>
<td>SR（State Register）</td>
<td>IE（Interrupt Enable）</td>
<td>0</td>
<td>全局中断使能，该位置 1 表示允许中断，置 0 表示禁止中断。</td>
</tr>
<tr>
<td>Cause</td>
<td>BD（Branch Delay）</td>
<td>31</td>
<td>当该位置 1 的时候，EPC
指向当前指令的前一条指令（一定为跳转），否则指向当前指令。</td>
</tr>
<tr>
<td>Cause</td>
<td>IP（Interrupt Pending）</td>
<td>15:10</td>
<td>为 6 位待决的中断位，分别对应 6 个外部中断，相应位置 1
表示有中断，置 0
表示无中断，将会每个周期被修改一次，修改的内容来自计时器和外部中断。</td>
</tr>
<tr>
<td>Cause</td>
<td>ExcCode</td>
<td>6:2</td>
<td>异常编码，记录当前发生的是什么异常。</td>
</tr>
<tr>
<td>EPC</td>
<td>-</td>
<td>-</td>
<td>记录异常处理结束后需要返回的 PC。</td>
</tr>
</tbody>
</table>
<h4 id="模块接口">模块接口</h4>
<table>

<thead>
<tr>
<th>端口</th>
<th>方向</th>
<th>位数</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>clk</td>
<td>IN</td>
<td>1</td>
<td>时钟信号。</td>
</tr>
<tr>
<td>reset</td>
<td>IN</td>
<td>1</td>
<td>复位信号。</td>
</tr>
<tr>
<td>enable</td>
<td>IN</td>
<td>1</td>
<td>写使能信号。</td>
</tr>
<tr>
<td>CP0_addr</td>
<td>IN</td>
<td>5</td>
<td>寄存器地址。执行MTC0/MFCO指令时产生</td>
</tr>
<tr>
<td>CP0_in</td>
<td>IN</td>
<td>32</td>
<td>CP0 写入数据。执行MTC0指令时产生</td>
</tr>
<tr>
<td>CP0_out</td>
<td>OUT</td>
<td>32</td>
<td>CP0 读出数据。执行MFC0指令时产生，输出数据至 GPR</td>
</tr>
<tr>
<td>VPC</td>
<td>IN</td>
<td>32</td>
<td>受害 PC。</td>
</tr>
<tr>
<td>BD_in</td>
<td>IN</td>
<td>1</td>
<td>是否是延迟槽指令。</td>
</tr>
<tr>
<td>ExcCode_in</td>
<td>IN</td>
<td>5</td>
<td>记录异常类型。</td>
</tr>
<tr>
<td>HW_int</td>
<td>IN</td>
<td>6</td>
<td>输入中断信号。</td>
</tr>
<tr>
<td>EXL_clr</td>
<td>IN</td>
<td>1</td>
<td>用来复位 EXL。</td>
</tr>
<tr>
<td>EPC_out</td>
<td>OUT</td>
<td>32</td>
<td>EPC 的值。</td>
</tr>
<tr>
<td>Req</td>
<td>OUT</td>
<td>1</td>
<td>进入处理程序请求。</td>
</tr>
<tr>
<td>macroscopic_pc</td>
<td>OUT</td>
<td>[31:0]</td>
<td>宏观PC</td>
</tr>
</tbody>
</table>
<h4 id="异常编码">异常编码</h4>
<table>

<thead>
<tr>
<th>异常与中断码</th>
<th>助记符与名称</th>
<th>指令与指令类型</th>
<th>描述</th>
<th>检测模块</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>Int</code> （外部中断）</td>
<td>所有指令</td>
<td>中断请求，来源于计时器与外部中断。</td>
<td>\</td>
</tr>
<tr>
<td>4</td>
<td><code>AdEL</code> （取指异常）</td>
<td>所有指令</td>
<td>PC 地址未字对齐。</td>
<td>IF</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>PC 地址超过 <code>0x3000 ~ 0x6ffc</code>。</td>
<td>IF</td>
</tr>
<tr>
<td></td>
<td><code>AdEL</code> （取数异常）</td>
<td><code>lw</code></td>
<td>取数地址未与 4 字节对齐。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>lh</code></td>
<td>取数地址未与 2 字节对齐。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>lh</code>, <code>lb</code></td>
<td>取 Timer 寄存器的值。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td>load 型指令</td>
<td>计算地址时加法溢出。</td>
<td>EX</td>
</tr>
<tr>
<td></td>
<td></td>
<td>load 型指令</td>
<td>取数地址超出 DM、Timer0、Timer1、中断发生器的范围。</td>
<td>MEM</td>
</tr>
<tr>
<td>5</td>
<td><code>AdES</code> （存数异常）</td>
<td><code>sw</code></td>
<td>存数地址未 4 字节对齐。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>sh</code></td>
<td>存数地址未 2 字节对齐。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>sh</code>, <code>sb</code></td>
<td>存 Timer 寄存器的值。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td>store 型指令</td>
<td>计算地址加法溢出。</td>
<td>EX</td>
</tr>
<tr>
<td></td>
<td></td>
<td>store 型指令</td>
<td>向计时器的 Count 寄存器存值。</td>
<td>MEM</td>
</tr>
<tr>
<td></td>
<td></td>
<td>store 型指令</td>
<td>存数地址超出 DM、Timer0、Timer1、中断发生器的范围。</td>
<td>MEM</td>
</tr>
<tr>
<td>8</td>
<td><code>Syscall</code> （系统调用）</td>
<td><code>syscall</code></td>
<td>系统调用。</td>
<td>ID</td>
</tr>
<tr>
<td>10</td>
<td><code>RI</code>（未知指令）</td>
<td>-</td>
<td>未知的指令码。</td>
<td>ID</td>
</tr>
<tr>
<td>12</td>
<td><code>Ov</code>（溢出异常）</td>
<td><code>add</code>, <code>addi</code>, <code>sub</code></td>
<td>算术溢出。</td>
<td>EX</td>
</tr>
</tbody>
</table>
<h3 id="阻塞矩阵">阻塞矩阵</h3>
<table>

<thead>
<tr>
<th>IF/ID当前指令</th>
<th></th>
<th></th>
<th>ID/EX</th>
<th></th>
<th></th>
<th>EX/MEM</th>
<th></th>
<th></th>
<th>MEM/WB</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>指令类型</td>
<td>源寄存器</td>
<td><span class="math inline">\(T_{use}\)</span></td>
<td>cal_r<br>1/rd)<br></td>
<td>cal_i<br>(1/rt)<br></td>
<td>load<br>(2/rt)<br></td>
<td>cal_r<br>(0/rd)</td>
<td>cal_i<br>(0/rt)</td>
<td>load<br>(1/rt)</td>
<td>cal_r<br>(0/rd)</td>
<td>cal_i<br>(0/rt)</td>
<td>load<br>(0/rt)</td>
</tr>
<tr>
<td>beq</td>
<td>rs/rt</td>
<td>0</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>cal_r</td>
<td>rs_rt</td>
<td>1</td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>cal_i</td>
<td>rs</td>
<td>1</td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>load</td>
<td>rs(base)</td>
<td>1</td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>store</td>
<td>rs(base)</td>
<td>1</td>
<td></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>store</td>
<td>rt</td>
<td>2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="暂停实现">暂停实现</h2>
<blockquote>
<p>使用课程讲解的AT法,在流水线运行期间,ID区提供<span class="math inline">\(T_{USE}\)</span>,EX,MEM区提供<span class="math inline">\(T_{NEW}\)</span>,在冒险控制模块中采用以下判断逻辑:</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">assign</span> STALL =  (ID_A1 == EX_A3 &amp;&amp; ID_A1_USE &lt; EX_NEW &amp;&amp; EX_A3 != <span class="hljs-number">0</span>)  <br>           || (ID_A2 == EX_A3 &amp;&amp; ID_A2_USE &lt; EX_NEW &amp;&amp; EX_A3 != <span class="hljs-number">0</span>)<br>           || (ID_A1 == MEM_A3 &amp;&amp; ID_A1_USE &lt; MEM_A2_NEW &amp;&amp; MEM_A3 != <span class="hljs-number">0</span>)<br>           || (ID_A2 == MEM_A3 &amp;&amp; ID_A2_USE &lt; MEM_A2_NEW &amp;&amp; MEM_A3 != <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>
<p>STALL信号会控制三个行为:</p>
<ol type="1">
<li>暂停IF区的PC模块</li>
<li>暂停IF_ID间流水寄存器</li>
<li>刷新ID_EX间流水寄存器(等同于reset)</li>
</ol>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">assign</span> Enable_PC = !STALL;<br><span class="hljs-keyword">assign</span> Enable_IF_ID = !STALL;<br><span class="hljs-keyword">assign</span> Flush_ID_EX = STALL;<br></code></pre></td></tr></table></figure>
</blockquote>
<h2 id="转发实现">转发实现</h2>
<blockquote>
<p>转发有五条可能的数据通路:</p>
<ol type="1">
<li><span class="math inline">\(EX\_MEM\rightarrow ID\)</span></li>
<li><span class="math inline">\(MEM\_WB\rightarrow ID\)</span></li>
<li><span class="math inline">\(EX\_MEM\rightarrow EX\)</span></li>
<li><span class="math inline">\(MEM\_WB\rightarrow EX\)</span></li>
<li><span class="math inline">\(MEM\_WB\rightarrow MEM\)</span></li>
</ol>
<p>这里以ID区的RD1转发数据逻辑为例:</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"><span class="hljs-keyword">assign</span> ID_RD1_forward = (ID_A1 == <span class="hljs-number">5&#x27;b0</span>) ? <span class="hljs-number">0</span> :<br>                        (ID_A1 == MEM_A3) ? MEM_WD :<br>                        (ID_A1 == WB_A3) ? WB_WD :<br>                        ID_RD1;<br></code></pre></td></tr></table></figure>
</blockquote>
<h2 id="寄存器内部转发实现">寄存器内部转发实现</h2>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Verilog"><span class="hljs-comment">// 考虑寄存器内部转发</span><br><span class="hljs-keyword">assign</span> RD1 = (A1 == A3 &amp;&amp; A1 != <span class="hljs-number">0</span> &amp;&amp; !reset) ? WD : grf[A1]; <br><span class="hljs-keyword">assign</span> RD2 = (A2 == A3 &amp;&amp; A2 != <span class="hljs-number">0</span> &amp;&amp; !reset) ? WD : grf[A2];<br></code></pre></td></tr></table></figure>
<h2 id="测试方案">测试方案</h2>
<ol type="1">
<li><code>Python</code>自动生成测试mips文件</li>
<li><code>Mars</code>运行mips文件,生成正确结果和机器码</li>
<li><code>iverilog</code>运行CPU文件,生成测试结果</li>
<li><code>Python</code>比较两份答案</li>
</ol>
<h2 id="思考题">思考题</h2>
<p>1、请查阅相关资料，说明鼠标和键盘的输入信号是如何被 CPU 知晓的？</p>
<blockquote>
<p>当键盘或者鼠标按下按键时,设备会发出一个中断信号,中断信号经过中断控制器传到CPU,CPU根据不同的中断号执行不同的中断响应程序,然后进行相应的IO操作</p>
</blockquote>
<p>2、请思考为什么我们的 CPU
处理中断异常必须是已经指定好的地址？如果你的 CPU
支持用户自定义入口地址，即处理中断异常的程序由用户提供，其还能提供我们所希望的功能吗？如果可以，请说明这样可能会出现什么问题？否则举例说明。（假设用户提供的中断处理程序合法）</p>
<blockquote>
<p>统一的CPU处理中断异常地址能够实现软件的兼容.</p>
<p>会影响CPU的处理逻辑</p>
</blockquote>
<p>3、为何与外设通信需要 Bridge？</p>
<blockquote>
<p>让CPU访问不同外设只需要通过对应的地址,这种操作遵循了"高内聚,低耦合"的原则</p>
</blockquote>
<p>4、请阅读官方提供的定时器源代码，阐述两种中断模式的异同，并分别针对每一种模式绘制状态移图。</p>
<blockquote>
<p>当计数器倒计数为0时,计数器停止计数,Ctrl寄存器的计数使能自动变为0,并且中断信号时钟保持有效,直到屏蔽中断或重新开始计数</p>
</blockquote>
<p><img src="image-20241121014635046.png" srcset="/img/loading.gif" lazyload alt="中断模式0" style="zoom:50%;"></p>
<blockquote>
<p>计数器模式1:</p>
<p>当计数器倒计数为0,自动读取PRESENT寄存器的值,然后重新开始倒计数,这种模式下中断信号只会产生一个中断周期</p>
</blockquote>
<p><img src="image-20241121014944531.png" srcset="/img/loading.gif" lazyload alt="中断模式1" style="zoom:50%;"></p>
<p>5、倘若中断信号流入的时候，在检测宏观 PC 的一级如果是一条空泡（你的
CPU 该级所有信息均为空）指令，此时会发生什么问题？在此例基础上请思考：在
P7 中，清空流水线产生的空泡指令应该保留原指令的哪些信息？</p>
<blockquote>
<p>宏观PC突然变为0x0000_0000</p>
<p>保留原指令的PC信息</p>
</blockquote>
<p>6、为什么 <code>jalr</code> 指令为什么不能写成
<code>jalr $31, $31</code>？</p>
<blockquote>
<p>若<code>jalr $31, $31</code>指令的延迟槽内发生异常或者需要响应中断,那么在处理异常结束后会再次执行<code>jalr $31, $31</code>指令,这时的$31值已经被修改,会跳转到不正确的PC地址</p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" class="category-chain-item">计算机组成原理</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CO/" class="print-no-link">#CO</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>P7-CPU设计文档</div>
      <div>https://meteor041.git.io/2024/12/02/P7-CPU设计文档/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>meteor041</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/02/P7%20debug%E6%80%BB%E7%BB%93/" title="P7-CPU设计文档">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">P7-CPU设计文档</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/11/30/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83/" title="随机变量及其分布">
                        <span class="hidden-mobile">随机变量及其分布</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"DEhrBdkKMTKuglAFuCaRa4x8-gzGzoHsz","appKey":"pUUnAo42ScpxvJ9HPTKdpwLM","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://dehrbdkk.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":true,"appid":"DEhrBdkKMTKuglAFuCaRa4x8-gzGzoHsz","appkey":"pUUnAo42ScpxvJ9HPTKdpwLM"},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
